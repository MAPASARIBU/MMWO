<div class="card">
    <div class="flex justify-between items-center mb-4">
        <h3>User Management</h3>
        <button onclick="openModal('createUserModal')" class="btn btn-primary">+ Add New User</button>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Mill</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <% users.forEach(u=> { %>
                    <tr>
                        <td>
                            <%= u.username %>
                        </td>
                        <td>
                            <%= u.name %>
                        </td>
                        <td><span class="badge badge-gray">
                                <%= u.role %>
                            </span></td>
                        <td>
                            <%= u.mill ? u.mill.name : 'All' %>
                        </td>
                        <td>
                            <span class="badge <%= u.is_active ? 'badge-green' : 'badge-red' %>">
                                <%= u.is_active ? 'Active' : 'Inactive' %>
                            </span>
                        </td>
                        <td>
                            <% if (u.username !=='admin' ) { %>
                                <button onclick="toggleActive(<%= u.id %>, <%= !u.is_active %>)"
                                    class="btn btn-sm btn-secondary">
                                    <%= u.is_active ? 'Deactivate' : 'Activate' %>
                                </button>
                                <% } %>
                        </td>
                    </tr>
                    <% }); %>
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal -->
<div id="createUserModal"
    style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 100;">
    <div class="card" style="margin: 50px auto; max-width: 500px;">
        <h3>Create New User</h3>
        <form id="createUserForm">
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" name="username" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" name="password" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" name="name" class="form-control" required>
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <select name="role" class="form-control" required>
                    <option value="PROC">PROC (Processing)</option>
                    <option value="MTC">MTC (Maintenance)</option>
                    <option value="SPV">SPV (Supervisor)</option>
                    <option value="MANAGER">MANAGER</option>
                    <option value="ADMIN">ADMIN</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Mill</label>
                <select name="mill_id" class="form-control">
                    <option value="">All Mills (Admin only)</option>
                    <% mills.forEach(m=> { %>
                        <option value="<%= m.id %>">
                            <%= m.name %>
                        </option>
                        <% }); %>
                </select>
            </div>

            <div class="flex justify-between mt-4">
                <button type="button" onclick="closeModal('createUserModal')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function toggleActive(id, isActive) {
        if (!confirm(`Are you sure you want to ${isActive ? 'activate' : 'deactivate'} this user?`)) return;

        try {
            const res = await fetch(`/api/users/${id}/active`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: isActive })
            });
            if (res.ok) window.location.reload();
            else alert('Error updating user');
        } catch (e) { console.error(e); }
    }

    document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) window.location.reload();
            else {
                const err = await res.json();
                alert('Error creating user: ' + err.error);
            }
        } catch (error) {
            console.error(error);
            alert('Error creating user');
        }
    });
</script>